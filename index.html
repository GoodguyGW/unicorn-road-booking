<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>유니콘로드 예약 시스템</title>
    <!-- 캘린더 기능을 위한 FullCalendar 라이브러리 추가 -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/locales/ko.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .rooms-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }
        .room-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            width: calc(33.33% - 20px);
            box-sizing: border-box;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        .room-card h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        .room-capacity {
            color: #666;
            font-size: 14px;
        }
        .btn {
            display: inline-block;
            background-color: #3498db;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 14px;
            border: none;
            cursor: pointer;
            margin-top: 10px;
        }
        .btn:hover {
            background-color: #2980b9;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .booking-list {
            margin-top: 30px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
        }
        .delete-btn {
            background-color: #e74c3c;
        }
        .delete-btn:hover {
            background-color: #c0392b;
        }
        .auth-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
        }
        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            border-bottom: 2px solid #ddd;
        }
        .auth-tab.active {
            border-bottom-color: #3498db;
            font-weight: bold;
        }
        .auth-form {
            display: none;
        }
        .auth-form.active {
            display: block;
        }
        .header-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .admin-panel {
            margin-top: 30px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }
        .tag {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .tag-admin {
            background-color: #e74c3c;
            color: white;
        }
        .tag-pending {
            background-color: #f39c12;
            color: white;
        }
        .tag-approved {
            background-color: #2ecc71;
            color: white;
        }
        
        /* 캘린더 스타일 추가 */
        .calendar-container {
            margin-top: 30px;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        #calendar {
            height: 650px;
        }
        
        .fc-event {
            cursor: pointer;
        }
        
        .fc-event-title {
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .tab-container {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .tab.active {
            border-bottom: 3px solid #3498db;
            color: #3498db;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* 사용자 데이터 테이블 스타일 */
        .user-stats {
            margin-top: 20px;
        }
        
        /* 반응형 스타일 */
        @media (max-width: 768px) {
            .room-card {
                width: calc(50% - 20px);
            }
        }
        
        @media (max-width: 480px) {
            .room-card {
                width: 100%;
            }
            
            .header-nav {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .user-info {
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- 인증 컨테이너 (로그인/회원가입) -->
    <div class="auth-container" id="authContainer">
        <h1>유니콘로드 예약 시스템</h1>
        <div class="auth-tabs">
            <div class="auth-tab active" data-tab="login">로그인</div>
            <div class="auth-tab" data-tab="register">회원가입</div>
        </div>
        
        <form id="loginForm" class="auth-form active">
            <div class="form-group">
                <label for="loginEmail">이메일:</label>
                <input type="email" id="loginEmail" required>
            </div>
            <div class="form-group">
                <label for="loginPassword">비밀번호:</label>
                <input type="password" id="loginPassword" required>
            </div>
            <button type="submit" class="btn" style="width: 100%;">로그인</button>
        </form>
        
        <form id="registerForm" class="auth-form">
            <div class="form-group">
                <label for="registerName">이름:</label>
                <input type="text" id="registerName" required>
            </div>
            <div class="form-group">
                <label for="registerEmail">이메일:</label>
                <input type="email" id="registerEmail" required>
            </div>
            <div class="form-group">
                <label for="registerDepartment">회사명:</label>
                <input type="text" id="registerDepartment" required>
            </div>
            <div class="form-group">
                <label for="registerPassword">비밀번호:</label>
                <input type="password" id="registerPassword" required>
            </div>
            <button type="submit" class="btn" style="width: 100%;">회원가입</button>
            <p style="text-align: center; margin-top: 15px; font-size: 14px; color: #666;">
                회원가입 후 관리자의 승인이 필요합니다.
            </p>
        </form>
    </div>

    <!-- 메인 애플리케이션 컨테이너 -->
    <div class="container" id="appContainer" style="display: none;">
        <div class="header-nav">
            <h1>유니콘로드 예약 시스템</h1>
            <div class="user-info">
                <span id="userDisplayName"></span>
                <span id="userStatus"></span>
                <button id="logoutBtn" class="btn" style="margin-left: 15px;">로그아웃</button>
            </div>
        </div>
        
        <div id="pendingApprovalMessage" style="display: none; background-color: #fff3cd; color: #856404; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
            회원가입 요청이 관리자에게 전송되었습니다. 승인을 기다려 주세요.
        </div>
        
        <div id="mainContent" style="display: none;">
            <!-- 탭 내비게이션 추가 -->
            <div class="tab-container">
                <div class="tab active" data-tab="rooms">회의실 예약</div>
                <div class="tab" data-tab="calendar">예약 현황</div>
                <div class="tab" data-tab="my-bookings">내 예약 목록</div>
            </div>
            
            <!-- 회의실 예약 탭 내용 -->
            <div id="roomsTab" class="tab-content active">
                <div class="rooms-container" id="roomsContainer">
                    <!-- 회의실 카드는 JavaScript로 동적 생성됩니다 -->
                </div>
            </div>
            
            <!-- 예약 현황 캘린더 탭 내용 -->
            <div id="calendarTab" class="tab-content">
                <div class="calendar-container">
                    <div id="calendar"></div>
                </div>
            </div>
            
            <!-- 내 예약 목록 탭 내용 -->
            <div id="myBookingsTab" class="tab-content" style="display: block;">
                <div class="booking-list">
                    <h2>내 예약 목록</h2>
                    <table id="bookingTable">
                        <thead>
                            <tr>
                                <th>장소</th>
                                <th>날짜</th>
                                <th>시간</th>
                                <th>목적</th>
                                <th>액션</th>
                            </tr>
                        </thead>
                        <tbody id="bookingTableBody">
                            <!-- 예약 목록은 JavaScript로 동적 생성됩니다 -->
                        </tbody>
                    </table>
                </div>

                <div class="booking-list" id="pastBookingSection" style="margin-top: 30px;">
                    <h2>지난 예약 목록</h2>
                    <button id="togglePastBookings" class="btn" style="margin-bottom: 10px;">지난 예약 보기</button>
                    <div id="pastBookingContent" style="display: none;">
                        <table id="pastBookingTable">
                            <thead>
                                <tr>
                                    <th>장소</th>
                                    <th>날짜</th>
                                    <th>시간</th>
                                    <th>목적</th>
                                </tr>
                            </thead>
                            <tbody id="pastBookingTableBody">
                                <!-- 지난 예약 목록은 JavaScript로 동적 생성됩니다 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- 관리자 패널 -->
            <div id="adminPanel" class="admin-panel" style="display: none;">
                <h2>관리자 패널</h2>
                
                <!-- 관리자 패널 탭 추가 -->
                <div id="adminTabContainer" class="tab-container">
                    <div class="tab active" data-tab="pending-users">승인 대기 사용자</div>
                    <div class="tab" data-tab="all-users">모든 사용자</div>
                    <div class="tab" data-tab="user-stats">사용자 통계</div>
                </div>
                
                <!-- 승인 대기 사용자 탭 -->
                <div id="pending-usersTab" class="tab-content active">
                    <h3>승인 대기 중인 사용자</h3>
                    <table id="pendingUsersTable">
                        <thead>
                            <tr>
                                <th>이름</th>
                                <th>이메일</th>
                                <th>회사명</th>
                                <th>가입일</th>
                                <th>액션</th>
                            </tr>
                        </thead>
                        <tbody id="pendingUsersTableBody">
                            <!-- 사용자 목록은 JavaScript로 동적 생성됩니다 -->
                        </tbody>
                    </table>
                </div>
                
                <!-- 모든 사용자 탭 -->
                <div id="all-usersTab" class="tab-content">
                    <h3>모든 사용자 관리</h3>
                    <!-- 사용자 정렬 옵션 추가 -->
                    <div style="margin-bottom: 15px;">
                        <label for="userSortOption">정렬 기준:</label>
                        <select id="userSortOption" style="width: auto; margin-left: 10px;">
                            <option value="name">이름 순</option>
                            <option value="department">회사명 순</option>
                            <option value="registeredAt">가입일 순</option>
                        </select>
                    </div>
                    <table id="allUsersTable">
                        <thead>
                            <tr>
                                <th>이름</th>
                                <th>이메일</th>
                                <th>회사명</th>
                                <th>가입일</th>
                                <th>상태</th>
                                <th>액션</th>
                            </tr>
                        </thead>
                        <tbody id="allUsersTableBody">
                            <!-- 사용자 목록은 JavaScript로 동적 생성됩니다 -->
                        </tbody>
                    </table>
                </div>
                
                <!-- 사용자 통계 탭 -->
                <div id="user-statsTab" class="tab-content">
                    <h3>사용자 통계</h3>
                    <div class="user-stats">
                        <table>
                            <tr>
                                <th>총 사용자 수</th>
                                <td id="totalUserCount">0</td>
                            </tr>
                            <tr>
                                <th>승인된 사용자 수</th>
                                <td id="approvedUserCount">0</td>
                            </tr>
                            <tr>
                                <th>대기 중인 사용자 수</th>
                                <td id="pendingUserCount">0</td>
                            </tr>
                            <tr>
                                <th>총 예약 건수</th>
                                <td id="totalBookingCount">0</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 예약 모달 -->
    <div id="bookingModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeModal">&times;</span>
            <h2>예약하기</h2>
            <form id="bookingForm">
                <input type="hidden" id="roomId">
                <div class="form-group">
                    <label for="roomName">장소:</label>
                    <input type="text" id="roomName" readonly>
                </div>
                <div class="form-group">
                    <label for="bookingDate">날짜:</label>
                    <input type="date" id="bookingDate" required>
                </div>
                <div class="form-group">
                    <label for="startTime">시작 시간:</label>
                    <select id="startTime" required>
                        <option value="">선택하세요</option>
                        <!-- 시간 옵션은 JavaScript로 동적 생성됩니다 -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="endTime">종료 시간:</label>
                    <select id="endTime" required>
                        <option value="">선택하세요</option>
                        <!-- 시간 옵션은 JavaScript로 동적 생성됩니다 -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="purpose">예약 목적:</label>
                    <input type="text" id="purpose" placeholder="간단한 회의 주제나 목적을 입력하세요" required>
                </div>
                <button type="submit" class="btn">예약하기</button>
            </form>
        </div>
    </div>
    
    <!-- 예약 상세 정보 모달 -->
    <div id="bookingDetailModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeDetailModal">&times;</span>
            <h2>예약 상세 정보</h2>
            <div id="bookingDetailContent">
                <p><strong>장소:</strong> <span id="detailRoomName"></span></p>
                <p><strong>날짜:</strong> <span id="detailDate"></span></p>
                <p><strong>시간:</strong> <span id="detailTime"></span></p>
                <p><strong>목적:</strong> <span id="detailPurpose"></span></p>
                <p><strong>예약자:</strong> <span id="detailUser"></span></p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      const firebaseConfig = {
        apiKey: "AIzaSyCwaMyiOwpnjYq3o4oNSscT4fBU_s-m4gk",
        authDomain: "uw-urrs.firebaseapp.com",
        projectId: "uw-urrs",
        storageBucket: "uw-urrs.firebasestorage.app",
        messagingSenderId: "69927058938",
        appId: "1:69927058938:web:fb273937e203c661cdf843",
        measurementId: "G-B41WKE9JX5"
      };

      // Firebase 초기화
      firebase.initializeApp(firebaseConfig);

      // Firebase 서비스 참조
      const auth = firebase.auth();
      const db = firebase.firestore();

      // 회의실 데이터를 저장할 배열
      let rooms = [];

      // 예약 데이터를 저장할 배열
      let bookings = [];
      
      // 모든 사용자 데이터를 저장할 배열
      let allUsers = [];
      
      // 캘린더 객체
      let calendar;

      // 현재 로그인한 사용자
      let currentUser = null;

      // 날짜 포맷 함수 (YYYY-MM-DD -> YYYY년 MM월 DD일)
      function formatDate(dateStr) {
          let date;
          
          if (dateStr instanceof Date) {
              date = dateStr;
          } else {
              date = new Date(dateStr);
          }
          
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          
          return `${year}년 ${month}월 ${day}일`;
      }
      
      // 시간 포맷 함수 (HH:MM -> HH시 MM분)
      function formatTime(timeStr) {
          const [hours, minutes] = timeStr.split(':');
          return `${hours}시 ${minutes}분`;
      }
      
      // 사용자 승인 함수
      function approveUser(userId) {
          if (confirm('이 사용자를 승인하시겠습니까?')) {
              db.collection('users').doc(userId).update({
                  status: 'approved'
              })
              .then(() => {
                  alert('사용자가 성공적으로 승인되었습니다.');
                  loadUserManagement(); // 사용자 목록 다시 로드
                  loadUserStatistics(); // 사용자 통계 업데이트
              })
              .catch((error) => {
                  console.error('사용자 승인 오류:', error);
                  alert('사용자 승인 중 오류가 발생했습니다.');
              });
          }
      }

      // 사용자 삭제 함수
      function deleteUser(userId) {
          if (confirm('정말로 이 사용자를 삭제하시겠습니까?')) {
              // 해당 사용자의 모든 예약 삭제
              db.collection('bookings')
                  .where('userId', '==', userId)
                  .get()
                  .then((querySnapshot) => {
                      const batch = db.batch();
                      querySnapshot.forEach((doc) => {
                          batch.delete(doc.ref);
                      });
                      return batch.commit();
                  })
                  .then(() => {
                      // 사용자 정보 삭제
                      return db.collection('users').doc(userId).delete();
                  })
                  .then(() => {
                      alert('사용자가 성공적으로 삭제되었습니다.');
                      loadUserManagement(); // 사용자 목록 다시 로드
                      loadUserStatistics(); // 사용자 통계 업데이트
                      loadAllBookings(); // 캘린더 업데이트
                  })
                  .catch((error) => {
                      console.error('사용자 삭제 오류:', error);
                      alert('사용자 삭제 중 오류가 발생했습니다.');
                  });
          }
      }

      // 관리자 기능: 사용자 관리 UI 로드
      function loadUserManagement() {
          // 승인 대기 중인 사용자 표시
          db.collection('users')
              .where('status', '==', 'pending')
              .get()
              .then((querySnapshot) => {
                  const pendingTableBody = document.getElementById('pendingUsersTableBody');
                  pendingTableBody.innerHTML = '';
                  
                  if (querySnapshot.empty) {
                      const row = document.createElement('tr');
                      row.innerHTML = '<td colspan="5" style="text-align: center;">승인 대기 중인 사용자가 없습니다.</td>';
                      pendingTableBody.appendChild(row);
                      return;
                  }
                  
                  const pendingUsers = [];
                  querySnapshot.forEach((doc) => {
                      pendingUsers.push({
                          id: doc.id,
                          ...doc.data()
                      });
                  });
                  
                  // 이름순으로 정렬
                  pendingUsers.sort((a, b) => a.name.localeCompare(b.name, 'ko'));
                  
                  pendingUsers.forEach((user) => {
                      const row = document.createElement('tr');
                      
                      // Firebase Timestamp를 Date 객체로 변환
                      let registeredDate = '날짜 정보 없음';
                      if (user.registeredAt) {
                          const timestamp = user.registeredAt.toDate ? user.registeredAt.toDate() : new Date(user.registeredAt);
                          registeredDate = formatDate(timestamp);
                      }
                      
                      row.innerHTML = `
                          <td>${user.name}</td>
                          <td>${user.email}</td>
                          <td>${user.department}</td>
                          <td>${registeredDate}</td>
                          <td>
                              <button class="btn approve-btn" data-id="${user.id}">승인</button>
                              <button class="btn delete-btn" data-id="${user.id}">거부</button>
                          </td>
                      `;
                      pendingTableBody.appendChild(row);
                  });
                  
                  // 승인 버튼 이벤트 리스너
                  document.querySelectorAll('.approve-btn').forEach(btn => {
                      btn.addEventListener('click', function() {
                          const userId = this.getAttribute('data-id');
                          approveUser(userId);
                      });
                  });
                  
                  // 거부(삭제) 버튼 이벤트 리스너
                  document.querySelectorAll('.delete-btn').forEach(btn => {
                      btn.addEventListener('click', function() {
                          const userId = this.getAttribute('data-id');
                          deleteUser(userId);
                      });
                  });
              })
              .catch((error) => {
                  console.error('대기 중인 사용자 로드 오류:', error);
              });
          
          // 모든 사용자 로드 및 정렬 표시
          loadAllUsers();
      }
      
      // 모든 사용자 로드
      function loadAllUsers() {
          db.collection('users')
              .get()
              .then((querySnapshot) => {
                  allUsers = [];
                  querySnapshot.forEach((doc) => {
                      allUsers.push({
                          id: doc.id,
                          ...doc.data()
                      });
                  });
                  
                  // 이름순으로 정렬하여 표시
                  sortAndDisplayUsers();
              })
              .catch((error) => {
                  console.error('사용자 데이터 로드 오류:', error);
              });
      }
      
      // 사용자 정렬 및 표시
      function sortAndDisplayUsers() {
          const sortOption = document.getElementById('userSortOption').value;
          const allTableBody = document.getElementById('allUsersTableBody');
          allTableBody.innerHTML = '';
          
          if (allUsers.length === 0) {
              const row = document.createElement('tr');
              row.innerHTML = '<td colspan="6" style="text-align: center;">사용자가 없습니다.</td>';
              allTableBody.appendChild(row);
              return;
          }
          
          // 선택된 옵션에 따라 정렬
          if (sortOption === 'name') {
              allUsers.sort((a, b) => a.name.localeCompare(b.name, 'ko'));
          } else if (sortOption === 'department') {
              allUsers.sort((a, b) => a.department.localeCompare(b.department, 'ko'));
          } else if (sortOption === 'registeredAt') {
              allUsers.sort((a, b) => {
                  const dateA = a.registeredAt ? a.registeredAt.toDate ? a.registeredAt.toDate() : new Date(a.registeredAt) : new Date(0);
                  const dateB = b.registeredAt ? b.registeredAt.toDate ? b.registeredAt.toDate() : new Date(b.registeredAt) : new Date(0);
                  return dateB - dateA; // 최신순
              });
          }
          
          // 정렬된 사용자 표시 (현재 로그인한 관리자 제외)
          allUsers.filter(user => user.id !== currentUser.id).forEach((user) => {
              const row = document.createElement('tr');
              
              // Firebase Timestamp를 Date 객체로 변환
              let registeredDate = '날짜 정보 없음';
              if (user.registeredAt) {
                  const timestamp = user.registeredAt.toDate ? user.registeredAt.toDate() : new Date(user.registeredAt);
                  registeredDate = formatDate(timestamp);
              }
              
              const statusLabel = user.status === 'approved' ? 
                  '<span class="tag tag-approved">승인됨</span>' : 
                  '<span class="tag tag-pending">대기중</span>';
              
              row.innerHTML = `
                  <td>${user.name}</td>
                  <td>${user.email}</td>
                  <td>${user.department}</td>
                  <td>${registeredDate}</td>
                  <td>${statusLabel}</td>
                  <td>
                      ${user.status === 'pending' ? 
                      `<button class="btn approve-btn" data-id="${user.id}">승인</button>` : 
                      ''}
                      <button class="btn delete-btn" data-id="${user.id}">삭제</button>
                  </td>
              `;
              allTableBody.appendChild(row);
          });
          
          // 승인 버튼 이벤트 리스너
          document.querySelectorAll('.approve-btn').forEach(btn => {
              btn.addEventListener('click', function() {
                  const userId = this.getAttribute('data-id');
                  approveUser(userId);
              });
          });
          
          // 삭제 버튼 이벤트 리스너
          document.querySelectorAll('.delete-btn').forEach(btn => {
              btn.addEventListener('click', function() {
                  const userId = this.getAttribute('data-id');
                  deleteUser(userId);
              });
          });
      }
      
      // 사용자 통계 로드
      function loadUserStatistics() {
          // 모든 사용자 수
          db.collection('users').get()
              .then(snapshot => {
                  document.getElementById('totalUserCount').textContent = snapshot.size;
              });
          
          // 승인된 사용자 수
          db.collection('users').where('status', '==', 'approved').get()
              .then(snapshot => {
                  document.getElementById('approvedUserCount').textContent = snapshot.size;
              });
          
          // 대기 중인 사용자 수
          db.collection('users').where('status', '==', 'pending').get()
              .then(snapshot => {
                  document.getElementById('pendingUserCount').textContent = snapshot.size;
              });
          
          // 총 예약 건수
          db.collection('bookings').get()
              .then(snapshot => {
                  document.getElementById('totalBookingCount').textContent = snapshot.size;
              });
      }

      // 예약 제출 처리
      function handleBookingSubmit(e) {
          e.preventDefault();
          
          const roomId = document.getElementById('roomId').value;
          const roomName = document.getElementById('roomName').value;
          const date = document.getElementById('bookingDate').value;
          const startTime = document.getElementById('startTime').value;
          const endTime = document.getElementById('endTime').value;
          const purpose = document.getElementById('purpose').value;
          
          // 간단한 유효성 검사
          if (new Date(`${date}T${startTime}`) >= new Date(`${date}T${endTime}`)) {
              alert('종료 시간은 시작 시간보다 이후여야 합니다.');
              return;
          }
          
          // 당일 예약 시간 검사
          const today = new Date().toISOString().split('T')[0];
          if (date === today) {
              const now = new Date();
              const bookingStartTime = new Date(`${date}T${startTime}`);
              
              if (bookingStartTime < now) {
                  alert('현재 시간 이후로만 예약할 수 있습니다.');
                  return;
              }
          }
          
          // 예약 중복 확인
          checkBookingOverlap(roomId, date, startTime, endTime)
              .then(isOverlap => {
                  if (isOverlap) {
                      alert('선택한 시간에 이미 예약이 있습니다. 다른 시간을 선택해주세요.');
                      return;
                  }
                  
                  // 새 예약 추가
                  const newBooking = {
                      userId: currentUser.id,
                      userName: currentUser.name,
                      userDepartment: currentUser.department,
                      roomId,
                      roomName,
                      date,
                      startTime,
                      endTime,
                      purpose,
                      createdAt: firebase.firestore.FieldValue.serverTimestamp()
                  };
                  
                  // Firestore에 예약 정보 저장
                  db.collection('bookings').add(newBooking)
                      .then(() => {
                          alert('예약이 성공적으로 완료되었습니다!');
                          loadBookings(); // 예약 목록 다시 로드
                          loadAllBookings(); // 캘린더 업데이트
                          
                          // 모달 닫기 및 폼 초기화
                          document.getElementById('bookingModal').style.display = 'none';
                          document.getElementById('bookingForm').reset();
                          
                          // 현재 날짜로 다시 초기화
                          document.getElementById('bookingDate').value = today;
                          updateTimeOptions();
                      })
                      .catch(error => {
                          console.error('예약 생성 오류:', error);
                          alert('예약 생성 중 오류가 발생했습니다.');
                      });
              })
              .catch(error => {
                  console.error('예약 중복 확인 오류:', error);
                  alert('예약 중복 확인 중 오류가 발생했습니다.');
              });
      }

      // 예약 중복 확인
      function checkBookingOverlap(roomId, date, startTime, endTime) {
          return db.collection('bookings')
              .where('roomId', '==', roomId)
              .where('date', '==', date)
              .get()
              .then((querySnapshot) => {
                  let isOverlap = false;
                  
                  const newStart = new Date(`${date}T${startTime}`);
                  const newEnd = new Date(`${date}T${endTime}`);
                  
                  querySnapshot.forEach((doc) => {
                      const booking = doc.data();
                      const existingStart = new Date(`${booking.date}T${booking.startTime}`);
                      const existingEnd = new Date(`${booking.date}T${booking.endTime}`);
                      
                      if (
                          (newStart >= existingStart && newStart < existingEnd) ||
                          (newEnd > existingStart && newEnd <= existingEnd) ||
                          (newStart <= existingStart && newEnd >= existingEnd)
                      ) {
                          isOverlap = true;
                      }
                  });
                  
                  return isOverlap;
              });
      }

      // 예약 취소 함수
      function deleteBooking(id) {
          if (confirm('정말로 이 예약을 취소하시겠습니까?')) {
              db.collection('bookings').doc(id).delete()
                  .then(() => {
                      alert('예약이 취소되었습니다.');
                      loadBookings(); // 예약 목록 다시 로드
                      loadAllBookings(); // 캘린더 업데이트
                  })
                  .catch((error) => {
                      console.error('예약 취소 오류:', error);
                      alert('예약 취소 중 오류가 발생했습니다.');
                  });
          }
      }

      // 로그인 후 UI 업데이트 함수 수정
function updateUIForLoggedInUser() {
    console.log('로그인 후 UI 업데이트 시작');
    document.getElementById('authContainer').style.display = 'none';
    document.getElementById('appContainer').style.display = 'block';
    
    if (currentUser.status === 'pending') {
        showPendingApprovalMessage();
        return;
    }
    
    document.getElementById('pendingApprovalMessage').style.display = 'none';
    document.getElementById('mainContent').style.display = 'block';
    
    // 사용자 정보 표시
    document.getElementById('userDisplayName').textContent = `${currentUser.name} (${currentUser.department})`;
    
    // 관리자인 경우 태그 추가
    if (currentUser.role === 'admin') {
        document.getElementById('userStatus').innerHTML = '<span class="tag tag-admin">관리자</span>';
        document.getElementById('adminPanel').style.display = 'block';
        loadUserManagement();
        loadUserStatistics();
    } else {
        document.getElementById('userStatus').innerHTML = '<span class="tag tag-approved">승인됨</span>';
        document.getElementById('adminPanel').style.display = 'none';
    }
    
    // 회의실 카드 표시
    loadRooms();
    
    // 내 예약 목록 표시
    loadBookings();
    
    // 캘린더 초기화
    initializeCalendar();
    
    // 모달 설정
    setupModalEvents();
    
    // 시간 옵션 초기화
    updateTimeOptions();
    
    // 탭 컨테이너의 활성 탭 설정 (초기 상태는 첫 번째 탭)
    const activeTab = document.querySelector('.tab-container .tab.active');
    if (activeTab) {
        console.log('활성 탭 클릭 트리거:', activeTab.getAttribute('data-tab'));
        activeTab.click();
    }
    
    console.log('UI 업데이트 완료');
}

      // 승인 대기 메시지 표시
      function showPendingApprovalMessage() {
          document.getElementById('authContainer').style.display = 'none';
          document.getElementById('appContainer').style.display = 'block';
          document.getElementById('pendingApprovalMessage').style.display = 'block';
          document.getElementById('mainContent').style.display = 'none';
          
          if (currentUser.name) {
              document.getElementById('userDisplayName').textContent = `${currentUser.name} (${currentUser.department})`;
          } else {
              document.getElementById('userDisplayName').textContent = '승인 대기 중';
          }
          document.getElementById('userStatus').innerHTML = '<span class="tag tag-pending">승인 대기</span>';
      }

      // 로그아웃 처리
      function handleLogout() {
          auth.signOut()
              .then(() => {
                  currentUser = null;
                  document.getElementById('appContainer').style.display = 'none';
                  document.getElementById('authContainer').style.display = 'block';
                  
                  // 폼 초기화
                  document.getElementById('loginForm').reset();
                  document.getElementById('registerForm').reset();
              })
              .catch((error) => {
                  console.error('로그아웃 오류:', error);
              });
      }

      // 회의실 데이터 로드
      function loadRooms() {
          db.collection('rooms').get()
              .then((querySnapshot) => {
                  rooms = [];
                  querySnapshot.forEach((doc) => {
                      rooms.push({
                          id: doc.id,
                          ...doc.data()
                      });
                  });
                  displayRooms();
              })
              .catch((error) => {
                  console.error('회의실 데이터 로드 오류:', error);
              });
      }

      // 회의실 카드 표시 함수
      function displayRooms() {
          const container = document.getElementById('roomsContainer');
          container.innerHTML = '';
          
          rooms.forEach(room => {
              const card = document.createElement('div');
              card.className = 'room-card';
              card.innerHTML = `
                  <h3>${room.name}</h3>
                  <div class="room-capacity">수용 인원: ${room.capacity}명</div>
                  <div>제공 장비: ${room.equipment}</div>
                  <button class="btn book-btn" data-id="${room.id}" data-name="${room.name}">예약하기</button>
              `;
              container.appendChild(card);
          });
          
          // 예약 버튼에 이벤트 리스너 추가
          document.querySelectorAll('.book-btn').forEach(btn => {
              btn.addEventListener('click', function() {
                  const roomId = this.getAttribute('data-id');
                  const roomName = this.getAttribute('data-name');
                  openBookingModal(roomId, roomName);
              });
          });
      }

      // 예약 데이터 로드
      // 수정된 loadBookings 함수
function loadBookings() {
    console.log('예약 데이터 로드 함수 시작');
    if (!currentUser || !currentUser.id) {
        console.error('사용자 정보 없음');
        return;
    }
 
    db.collection('bookings')
        .where('userId', '==', currentUser.id)
        .get()
        .then((querySnapshot) => {
            // 기존 코드 유지...
            
            bookings = [];
            querySnapshot.forEach((doc) => {
                bookings.push({
                    id: doc.id,
                    ...doc.data()
                });
            });

            console.log('예약 데이터 로드 완료:', bookings.length + '개');
            displayBookings();
            
            // 추가: 내 예약 목록 탭 강제 표시
            const myBookingsTab = document.getElementById('myBookingsTab');
            if (myBookingsTab) {
                console.log('내 예약 탭 강제 표시');
                myBookingsTab.style.display = 'block';
                myBookingsTab.classList.add('active');
            }
        })
        .catch((error) => {
            console.error('예약 데이터 로드 중 오류:', error);
        });
}

// 수정된 displayBookings 함수
function displayBookings() {
    console.log('예약 목록 표시 함수 시작');
    
    const tableBody = document.getElementById('bookingTableBody');
    const pastTableBody = document.getElementById('pastBookingTableBody');
    
    if (!tableBody || !pastTableBody) {
        console.error('예약 테이블 요소를 찾을 수 없음');
        return;
    }
    
    tableBody.innerHTML = '';
    pastTableBody.innerHTML = '';
    
    // 현재 날짜 가져오기
    const today = new Date();
    today.setHours(0, 0, 0, 0); // 오늘 날짜의 00:00:00으로 설정

    // 예약을 현재(미래)와 과거로 분리
    const futureBookings = [];
    const pastBookings = [];
    
    bookings.forEach(booking => {
        const bookingDate = new Date(booking.date);
        bookingDate.setHours(0, 0, 0, 0);
        
        if (bookingDate >= today) {
            futureBookings.push(booking);
        } else {
            pastBookings.push(booking);
        }
    });
    
    console.log('미래 예약:', futureBookings.length, '과거 예약:', pastBookings.length);
          
    // 현재 예약 표시
    if (futureBookings.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="5" style="text-align: center;">예약 내역이 없습니다.</td>';
        tableBody.appendChild(row);
    } else {
        // 날짜 기준 정렬
        futureBookings.sort((a, b) => {
            const dateA = new Date(`${a.date}T${a.startTime}`);
            const dateB = new Date(`${b.date}T${b.startTime}`);
            return dateA - dateB;
        });
        
        futureBookings.forEach(booking => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${booking.roomName}</td>
                <td>${formatDate(booking.date)}</td>
                <td>${formatTime(booking.startTime)} - ${formatTime(booking.endTime)}</td>
                <td>${booking.purpose}</td>
                <td><button class="btn delete-btn" data-id="${booking.id}">취소</button></td>
            `;
            tableBody.appendChild(row);
        });
    }
    
    // 지난 예약 표시
    if (pastBookings.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="4" style="text-align: center;">지난 예약 내역이 없습니다.</td>';
        pastTableBody.appendChild(row);
    } else {
        // 날짜 기준 내림차순 정렬 (최근 것이 위에 오도록)
        pastBookings.sort((a, b) => {
            const dateA = new Date(`${a.date}T${a.startTime}`);
            const dateB = new Date(`${b.date}T${b.startTime}`);
            return dateB - dateA;
        });
        
        pastBookings.forEach(booking => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${booking.roomName}</td>
                <td>${formatDate(booking.date)}</td>
                <td>${formatTime(booking.startTime)} - ${formatTime(booking.endTime)}</td>
                <td>${booking.purpose}</td>
            `;
            pastTableBody.appendChild(row);
        });
    }
    
    // 예약 취소 버튼에 이벤트 리스너 추가
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const bookingId = this.getAttribute('data-id');
            deleteBooking(bookingId);
        });
    });
    
    console.log('예약 목록 표시 완료');
}

      // 모달 관련 이벤트 설정
      function setupModalEvents() {
          const bookingModal = document.getElementById('bookingModal');
          const closeModal = document.getElementById('closeModal');
          
          closeModal.onclick = function() {
              bookingModal.style.display = 'none';
          }
          
          const detailModal = document.getElementById('bookingDetailModal');
          const closeDetailModal = document.getElementById('closeDetailModal');
          
          closeDetailModal.onclick = function() {
              detailModal.style.display = 'none';
          }
          
          window.onclick = function(event) {
              if (event.target === bookingModal) {
                  bookingModal.style.display = 'none';
              }
              if (event.target === detailModal) {
                  detailModal.style.display = 'none';
              }
          }
      }

      // 예약 모달 열기
      function openBookingModal(roomId, roomName) {
          document.getElementById('roomId').value = roomId;
          document.getElementById('roomName').value = roomName;
          document.getElementById('bookingModal').style.display = 'block';
          
          // 시간 옵션 업데이트
          updateTimeOptions();
      }
      
      // 캘린더를 초기화하고 예약 데이터를 표시하는 함수
      function initializeCalendar() {
          const calendarEl = document.getElementById('calendar');
          
          calendar = new FullCalendar.Calendar(calendarEl, {
              initialView: 'dayGridMonth',
              headerToolbar: {
                  left: 'prev,next today',
                  center: 'title',
                  right: 'dayGridMonth,timeGridWeek,timeGridDay'
              },
              locale: 'ko',
              height: 'auto',
              allDaySlot: false,
              slotMinTime: '09:00:00',
              slotMaxTime: '19:00:00',
              eventClick: function(info) {
                  showBookingDetail(info.event);
              }
          });
          
          // 모든 예약 데이터 로드
          loadAllBookings();
      }
      
      // 예약 상세 정보 표시
      function showBookingDetail(event) {
          const bookingData = event.extendedProps;
          
          document.getElementById('detailRoomName').textContent = bookingData.roomName;
          document.getElementById('detailDate').textContent = formatDate(bookingData.date);
          document.getElementById('detailTime').textContent = `${formatTime(bookingData.startTime)} - ${formatTime(bookingData.endTime)}`;
          document.getElementById('detailPurpose').textContent = bookingData.purpose;
          document.getElementById('detailUser').textContent = bookingData.userName || '(정보 없음)';
          
          document.getElementById('bookingDetailModal').style.display = 'block';
      }
      
      // 모든 예약 데이터 로드 (캘린더용)
      function loadAllBookings() {
          db.collection('bookings').get()
              .then(async (querySnapshot) => {
                  const calendarEvents = [];
                  const userPromises = [];
                  const userCache = {};
                  
                  querySnapshot.forEach((doc) => {
                      const booking = {
                          id: doc.id,
                          ...doc.data()
                      };
                      
                      // 사용자 정보를 가져오기 위한 프로미스 생성
                      if (!userCache[booking.userId]) {
                          const userPromise = db.collection('users').doc(booking.userId).get()
                              .then(userDoc => {
                                  if (userDoc.exists) {
                                      userCache[booking.userId] = userDoc.data().name;
                                  } else {
                                      userCache[booking.userId] = '(사용자 정보 없음)';
                                  }
                                  return userCache[booking.userId];
                              });
                          userPromises.push(userPromise);
                      }
                  });
                  
                  // 모든 사용자 정보 로드 완료 대기
                  await Promise.all(userPromises);
                  
                  // 캘린더 이벤트 생성
                  querySnapshot.forEach((doc) => {
                      const booking = {
                          id: doc.id,
                          ...doc.data()
                      };
                      
                      const userName = userCache[booking.userId] || '(사용자 정보 없음)';
                      
                      calendarEvents.push({
                          id: booking.id,
                          title: `${booking.roomName} - ${userName}`,
                          start: `${booking.date}T${booking.startTime}`,
                          end: `${booking.date}T${booking.endTime}`,
                          backgroundColor: getRandomColor(booking.roomName),
                          borderColor: getRandomColor(booking.roomName),
                          extendedProps: {
                              roomName: booking.roomName,
                              date: booking.date,
                              startTime: booking.startTime,
                              endTime: booking.endTime,
                              purpose: booking.purpose,
                              userId: booking.userId,
                              userName: userName
                          }
                      });
                  });
                  
                  // 캘린더에 이벤트 추가
                  calendar.removeAllEvents();
                  calendar.addEventSource(calendarEvents);
              })
              .catch((error) => {
                  console.error('예약 데이터 로드 오류:', error);
              });
      }
      
      // 방 이름에 따라 일관된 색상 생성
      function getRandomColor(str) {
          let hash = 0;
          for (let i = 0; i < str.length; i++) {
              hash = str.charCodeAt(i) + ((hash << 5) - hash);
          }
          
          const colors = [
              '#4285F4', // blue
              '#EA4335', // red
              '#FBBC05', // yellow
              '#34A853', // green
              '#FF6D01', // orange
              '#46BDC6', // teal
              '#7B1FA2', // purple
              '#0097A7', // cyan
              '#689F38', // light green
              '#F06292'  // pink
          ];
          
          // 해시값에 따라 색상 배열에서 선택
          return colors[Math.abs(hash) % colors.length];
      }
      
      // 시간 옵션 업데이트 (당일 예약인 경우 현재 시간 이후만 선택 가능)
      function updateTimeOptions() {
          const startTimeSelect = document.getElementById('startTime');
          const endTimeSelect = document.getElementById('endTime');
          const selectedDate = document.getElementById('bookingDate').value;
          
          // 선택 옵션 초기화
          startTimeSelect.innerHTML = '<option value="">선택하세요</option>';
          endTimeSelect.innerHTML = '<option value="">선택하세요</option>';
          
          // 시간 옵션 (30분 단위)
          const timeOptions = [
              '09:00', '09:30', '10:00', '10:30', '11:00', '11:30',
              '12:00', '12:30', '13:00', '13:30', '14:00', '14:30',
              '15:00', '15:30', '16:00', '16:30', '17:00', '17:30', '18:00'
          ];
          
          // 종료 시간은 30분 더 추가
          const endTimeOptions = [...timeOptions, '18:30'];
          
          // 현재 날짜와 시간
          const now = new Date();
          const today = now.toISOString().split('T')[0];
          
          // 현재 시간을 30분 단위로 올림
          let currentHour = now.getHours();
          let currentMinute = now.getMinutes();
          if (currentMinute > 0) {
              currentMinute = currentMinute <= 30 ? 30 : 0;
              if (currentMinute === 0) {
                  currentHour += 1;
              }
          }
          
          // 당일 예약인 경우 현재 시간 이후만 선택 가능
          if (selectedDate === today) {
              const currentTimeStr = `${String(currentHour).padStart(2, '0')}:${String(currentMinute).padStart(2, '0')}`;
              
              timeOptions.forEach(time => {
                  if (time >= currentTimeStr) {
                      const option = document.createElement('option');
                      option.value = time;
                      option.textContent = `${time.split(':')[0]}시 ${time.split(':')[1]}분`;
                      startTimeSelect.appendChild(option);
                  }
              });
              
              endTimeOptions.forEach(time => {
                  if (time > currentTimeStr) {
                      const option = document.createElement('option');
                      option.value = time;
                      option.textContent = `${time.split(':')[0]}시 ${time.split(':')[1]}분`;
                      endTimeSelect.appendChild(option);
                  }
              });
          } else {
              // 당일이 아닌 경우 모든 시간 옵션 표시
              timeOptions.forEach(time => {
                  const option = document.createElement('option');
                  option.value = time;
                  option.textContent = `${time.split(':')[0]}시 ${time.split(':')[1]}분`;
                  startTimeSelect.appendChild(option);
              });
              
              endTimeOptions.forEach(time => {
                  const option = document.createElement('option');
                  option.value = time;
                  option.textContent = `${time.split(':')[0]}시 ${time.split(':')[1]}분`;
                  endTimeSelect.appendChild(option);
              });
          }
      }

      // 사용자 데이터 가져오기
      function getUserData(userId) {
          db.collection('users').doc(userId).get()
              .then((doc) => {
                  if (doc.exists) {
                      currentUser = {
                          id: userId,
                          ...doc.data()
                      };
                      updateUIForLoggedInUser();
                  } else {
                      // 사용자 정보가 없는 경우 (새로 회원가입한 경우)
                      currentUser = {
                          id: userId,
                          status: 'pending'
                      };
                      showPendingApprovalMessage();
                  }
              })
              .catch((error) => {
                  console.error('사용자 데이터 로드 오류:', error);
                  alert('사용자 정보를 가져오는 중 오류가 발생했습니다.');
              });
      }

      // 탭 전환 이벤트 설정
// 탭 전환 이벤트 설정
// 수정된 setupTabEvents 함수
function setupTabEvents() {
    // 메인 콘텐츠 탭
    document.querySelectorAll('.tab-container .tab').forEach(tab => {
        tab.addEventListener('click', function() {
            // 안전한 탭 컨테이너 찾기
            const tabContainer = this.closest('.tab-container');
            const tabContainerId = tabContainer ? (tabContainer.id || '') : '';
            
            // 만약 tabContainer가 null이 아닐 경우에만 처리
            if (tabContainer) {
                // 해당 탭 컨테이너 내의 모든 탭 비활성화
                tabContainer.querySelectorAll('.tab').forEach(t => {
                    if (t) t.classList.remove('active');
                });
                
                // 클릭한 탭 활성화
                this.classList.add('active');
                
                const tabName = this.getAttribute('data-tab');
                
                // 관리자 패널 탭인 경우
                if (tabContainerId === 'adminTabContainer') {
                    const adminPanel = document.getElementById('adminPanel');
                    if (adminPanel) {
                        adminPanel.querySelectorAll('.tab-content').forEach(content => {
                            if (content) {
                                content.classList.remove('active');
                                content.style.display = 'none';
                            }
                        });
                        
                        const targetTab = document.getElementById(`${tabName}Tab`);
                        if (targetTab) {
                            targetTab.classList.add('active');
                            targetTab.style.display = 'block';
                        }
                    }
                } 
                // 일반 탭인 경우
                else {
                    const mainContent = document.getElementById('mainContent');
                    if (mainContent) {
                        mainContent.querySelectorAll('.tab-content').forEach(content => {
                            if (content) {
                                content.classList.remove('active');
                                content.style.display = 'none';
                            }
                        });
                        
                        const targetTab = document.getElementById(`${tabName}Tab`);
                        if (targetTab) {
                            targetTab.classList.add('active');
                            targetTab.style.display = 'block';
                            
                            // 캘린더 탭을 선택한 경우 캘린더 크기 조정
                            if (tabName === 'calendar' && calendar) {
                                calendar.render();
                            }
                            
                            // 내 예약 목록 탭을 선택한 경우 예약 목록 갱신
                            if (tabName === 'my-bookings') {
                                console.log('내 예약 탭 활성화'); // 디버깅 메시지
                                loadBookings(); // 예약 데이터를 다시 로드하고 표시
                            }
                        }
                    }
                }
            }
        });
    });

    // 초기 상태 설정 - 첫 번째 탭 활성화
    const defaultTab = document.querySelector('.tab-container .tab.active');
    if (defaultTab) {
        // 기본 탭 클릭 이벤트 트리거
        defaultTab.click();
    }
}
      

      // 초기 데이터 설정 (처음 실행 시)
function setupInitialData() {
    // 기본 회의실 데이터 추가
    const roomsRef = db.collection('rooms');
    
    roomsRef.get().then((snapshot) => {
        if (snapshot.empty) {
            console.log('회의실 데이터 없음 - 초기 데이터 생성');
            // 데이터가 없으면 초기 데이터 추가
            const initialRooms = [
                { name: '회의실1', capacity: 4, equipment: '화이트보드, 전자칠판' },
                { name: '회의실2', capacity: 4, equipment: '화이트보드' },
                { name: '화상 회의실', capacity: 20, equipment: '컴퓨터, 음향시스템, 전자칠판, 화상회의 장비' },
                { name: '스튜디오1', capacity: 3, equipment: '컴퓨터, 크로마키 배경지, 촬영장비(사무실보관)' },
                { name: '스튜디오2', capacity: 6, equipment: '제품촬영 스탠드, 배경지, 촬영장비(사무실보관)' },
                { name: '오픈세미나실', capacity: 30, equipment: '200인치 LED 디스플레이, 음향시스템' }
            ];
            
            const batch = db.batch();
            initialRooms.forEach(room => {
                const newRoomRef = roomsRef.doc();
                batch.set(newRoomRef, room);
            });
            
            return batch.commit();
        } else {
            console.log('회의실 데이터 존재 - 초기화 스킵');
        }
    }).catch(error => {
        console.error("초기 데이터 설정 오류:", error);
    });
       
          // 관리자 계정 추가 (없는 경우)
          const adminEmail = 'admin@example.com';
          const adminPassword = 'admin123';
          
          auth.fetchSignInMethodsForEmail(adminEmail)
              .then((signInMethods) => {
                  if (signInMethods.length === 0) {
                      // 관리자 계정이 없으면 생성
                      return auth.createUserWithEmailAndPassword(adminEmail, adminPassword);
                  }
                  return null;
              })
              .then((userCredential) => {
                  if (userCredential) {
                      const user = userCredential.user;
                      // Firestore에 관리자 정보 저장
                      return db.collection('users').doc(user.uid).set({
                          name: '관리자',
                          email: adminEmail,
                          department: '시스템 관리부',
                          role: 'admin',
                          status: 'approved',
                          registeredAt: firebase.firestore.FieldValue.serverTimestamp()
                      });
                  }
              })
              .catch((error) => {
                  // 이미 존재하는 경우 등 오류는 무시
                  console.log('관리자 계정 설정:', error.message);
              });
      }

      // 인증 관련 이벤트 설정
      function setupAuthEvents() {
          // 로그인/회원가입 탭 전환
          document.querySelectorAll('.auth-tab').forEach(tab => {
              tab.addEventListener('click', function() {
                  document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
                  this.classList.add('active');
                  
                  const tabName = this.getAttribute('data-tab');
                  document.querySelectorAll('.auth-form').forEach(form => form.classList.remove('active'));
                  document.getElementById(`${tabName}Form`).classList.add('active');
              });
          });
          
          // 로그인 폼 제출
          document.getElementById('loginForm').addEventListener('submit', function(e) {
              e.preventDefault();
              
              const email = document.getElementById('loginEmail').value;
              const password = document.getElementById('loginPassword').value;
              
              auth.signInWithEmailAndPassword(email, password)
                  .then((userCredential) => {
                      // 로그인 성공
                      const user = userCredential.user;
                      // 사용자 데이터는 onAuthStateChanged에서 처리
                  })
                  .catch((error) => {
                      alert('로그인 오류: ' + error.message);
                  });
          });
          
          // 회원가입 폼 제출
document.getElementById('registerForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const name = document.getElementById('registerName').value;
    const email = document.getElementById('registerEmail').value;
    const department = document.getElementById('registerDepartment').value;
    const password = document.getElementById('registerPassword').value;
    
    auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
            // 회원가입 성공
            const user = userCredential.user;
            
            // 사용자 정보 Firestore에 저장
            return db.collection('users').doc(user.uid).set({
                name: name,
                email: email,
                department: department,
                role: 'user',
                status: 'pending',
                registeredAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        })
        .then(() => {
            alert('회원가입이 완료되었습니다. 관리자 승인 후 시스템을 이용할 수 있습니다.');
        })
        .catch((error) => {
            // 오류 처리 개선
            if (error.code === 'auth/email-already-in-use') {
                alert('이미 사용 중인 이메일 주소입니다. 다른 이메일을 사용해주세요.');
            } else {
                alert('회원가입 오류: ' + error.message);
            }
        });
});
      }
      
      // DOM이 로드된 후 실행
      // DOM이 로드된 후 실행되는 코드 수정
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM 로드 완료');
    
    // 인증 관련 이벤트 설정
    setupAuthEvents();
    
    // 예약 모달 관련 이벤트
    setupModalEvents();
    
    // 예약 폼 제출 이벤트
    document.getElementById('bookingForm').addEventListener('submit', handleBookingSubmit);
    
    // 로그아웃 버튼 이벤트
    document.getElementById('logoutBtn').addEventListener('click', handleLogout);
    
    // 현재 날짜로 날짜 입력 필드 초기화
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('bookingDate').min = today;
    document.getElementById('bookingDate').value = today;
    
    // 예약 날짜 변경 이벤트
    document.getElementById('bookingDate').addEventListener('change', function() {
        updateTimeOptions();
    });
    
    // 지난 예약 토글 버튼 이벤트
    document.getElementById('togglePastBookings').addEventListener('click', function() {
        const pastBookingContent = document.getElementById('pastBookingContent');
        const isVisible = pastBookingContent.style.display === 'block';
        
        if (isVisible) {
            pastBookingContent.style.display = 'none';
            this.textContent = '지난 예약 보기';
        } else {
            pastBookingContent.style.display = 'block';
            this.textContent = '지난 예약 숨기기';
        }
    });
    
    // 사용자 정렬 옵션 변경 이벤트
    document.getElementById('userSortOption').addEventListener('change', function() {
        sortAndDisplayUsers();
    });

    // 초기 데이터 설정
    setupInitialData();

    // 탭 전환 이벤트 설정 - 다른 설정 후에 해야 초기 탭이 제대로 표시됨
    setupTabEvents();

    // 인증 상태 변경 감지
    auth.onAuthStateChanged(function(user) {
        if (user) {
            console.log('사용자 로그인 상태 감지');
            // 사용자 데이터 가져오기
            getUserData(user.uid);
        } else {
            // 로그인되지 않은 상태
            currentUser = null;
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('authContainer').style.display = 'block';
        }
    });
    // 내 예약 목록 탭 버튼에 직접 이벤트 핸들러 추가
const myBookingsTabButton = document.querySelector('.tab[data-tab="my-bookings"]');
if (myBookingsTabButton) {
    myBookingsTabButton.addEventListener('click', function() {
        console.log('내 예약 탭 버튼 클릭됨');
        const myBookingsTab = document.getElementById('myBookingsTab');
        if (myBookingsTab) {
            console.log('내 예약 탭 직접 표시');
            
            // 모든 탭 콘텐츠 숨기기
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
                content.classList.remove('active');
            });
            
            // 내 예약 탭 표시
            myBookingsTab.style.display = 'block';
            myBookingsTab.classList.add('active');
            
            // 예약 데이터 새로 로드
            loadBookings();
        }
    });
}
});
    </script>
</body>
</html>